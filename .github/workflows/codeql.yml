name: "CodeQL"
permissions:
    contents: read
    security-events: write
    packages: read

on:
    workflow_dispatch:
    push:
        branches:
            - main
        tags:
            - '*'
    pull_request:
        branches:
            - main

jobs:
    analyze-java-kotlin:
        name: Analyze (java-kotlin)
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                include:
                    -   language: java-kotlin
                        build-mode: manual

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4
            -   uses: actions/setup-java@v4
                with:
                    distribution: 'zulu'
                    java-version: '17'

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                    languages: java-kotlin
                    build-mode: autobuild
                    config: |
                        packs:
                        - codeql/java-queries:AlertSuppression.ql
                        - codeql/java-queries:AlertSuppressionAnnotations.ql
                    # packs: "codeql/java-queries:AlertSuppression.ql,codeql/java-queries:AlertSuppressionAnnotations.ql"

            #            -   if: matrix.build-mode == 'manual'
            #                shell: bash
            #                run: |
            #                    ./gradlew build

            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v3
                with:
                    category: "/language:java-kotlin"

            -   uses: actions/upload-artifact@v4
                with:
                    name: java.sarif
                    path: /home/runner/work/certificatetransparency/results/java.sarif
                    retention-days: 1

    analyze-actions:
        name: Analyze (actions)
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                include:
                    -   language: actions
                        build-mode: none

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                    languages: actions
                    build-mode: none

            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v3
                with:
                    category: "/language:actions"

            -   uses: actions/upload-artifact@v4
                with:
                    name: actions.sarif
                    path: /home/runner/work/certificatetransparency/results/actions.sarif
                    retention-days: 1
